# -*- coding: utf-8 -*-

import itertools
import re
import time

kanji = r'[㐀-䶵一-鿋豈-頻]'

wk = [["一","七","三","上","下","九","二","人","入","八","力","十","口","大","女","山","川","工"],["々","丁","中","丸","了","五","六","円","出","刀","千","又","右","四","土","夕","天","子","小","左","手","才","文","日","月","木","本","正","水","火","犬","玉","王","田","白","目","立"],["万","今","元","公","内","冬","分","切","北","午","半","友","古","台","外","太","少","市","広","引","心","戸","方","止","母","毛","父","牛","生","用","矢"],["不","世","主","仕","他","代","休","先","写","去","号","名","央","字","宝","平","年","打","早","村","気","氷","申","男","町","百","皿","石","礼","竹","糸","耳","花","虫","見","貝","赤","足","車"],["交","会","体","何","作","兄","光","同","回","図","声","多","学","弟","当","形","来","林","毎","皮","社","空","米","羽","考","肉","自","色","草","行","西","角","言","谷","走","近","里","金","雨","青","音","麦"],["両","亡","京","全","前","化","南","向","国","地","夜","妹","姉","安","室","州","店","後","思","明","星","曲","有","東","次","歩","死","活","海","点","画","直","知","私","科","羊","茶","血","長","食","首"],["付","以","夏","失","家","弱","強","必","教","時","未","末","札","校","欠","氏","民","理","由","紙","組","船","記","辺","通","週","雪","風","高","魚","鳥","黄","黒"],["住","助","医","反","君","場","対","局","役","所","投","支","数","朝","森","楽","池","決","番","研","究","答","絵","者","話","買","身","道","間","雲","電","馬"],["乗","予","事","仮","使","保","具","勝","受","和","売","定","実","客","屋","度","持","新","服","泳","物","界","発","相","県","美","苦","表","要","試","談","負","返","送","部","重","験"],["始","最","業","横","歌","求","漢","病","算","終","線","習","聞","落","葉","親","語","読","調","起","路","転","軽","農","速","進","運","配","酒","鉄","開","院","集","頭","顔","飲","鳴"],["争","令","仲","伝","位","低","便","働","共","初","別","利","功","努","労","味","命","好","岸","意","成","戦","拾","指","放","昔","波","注","洋","特","神","秒","競","級","老","育","良","追"],["倍","僕","勉","動","合","員","商","寒","島","庭","待","息","悪","旅","族","暑","期","根","植","歯","泉","流","消","深","温","港","湯","球","登","着","短","祭","章","童","第","都","野","陽","階"],["像","億","問","器","士","宿","情","想","感","整","料","映","暗","様","標","橋","殺","然","熱","疑","皆","福","緑","練","詩","課","謝","賞","輪","選","銀","鏡","題","願","養","館","駅"],["例","卒","協","参","周","囲","固","基","妥","季","完","希","念","性","技","折","望","材","束","松","格","残","的","約","能","芸","術","雰","頑","骨"],["丈","仏","信","列","勇","区","単","司","坂","変","夫","寺","岩","帰","建","式","春","昨","昼","晩","晴","毒","法","泣","浅","猫","秋","築","紀","英","計","軍","飯"],["係","典","冒","冗","危","取","品","園","存","守","専","幸","府","弁","急","政","曜","書","治","浴","留","真","笑","箱","荷","証","辞","遠","門","関","阪","険","面"],["側","兵","劇","原","喜","因","堂","塩","官","察","席","常","干","幻","底","恋","悲","愛","敗","是","果","栄","梅","渉","無","細","結","署","薬","虚","覚","詳","説","識","警","非","鼻"],["借","僧","句","可","告","喫","報","座","弓","忘","枚","汽","洗","焼","煙","祈","禁","禅","種","等","胸","脳","訓","許","達","静","類"],["乱","冊","加","史","善","団","宇","宙","容","履","布","徒","得","忙","改","昆","易","暴","歴","比","混","減","笛","節","絡","続","舌","若","詞","財","連","閥","順"],["余","個","倒","厚","困","圧","在","夢","妨","妻","嫌","害","尻","尾","械","機","災","犯","率","産","確","穴","経","罪","臭","被","裕","論","議","防","難","震","飛"],["件","任","企","判","制","務","増","委","審","岡","批","挙","敵","断","条","査","検","権","派","済","省","税","素","総","義","解","設","評","認","責","資","際"],["価","値","副","勢","各","吸","営","坊","域","姿","宮","寝","応","態","提","援","案","状","示","策","統","置","罰","脱","藤","観","誕","費","賀","過","領"],["乳","俳","停","備","優","則","割","収","呼","城","宅","導","崎","師","幹","張","律","施","沢","準","演","現","看","秀","職","裁","規","護","贅","革","鬼"],["供","型","境","届","展","層","差","庁","担","株","武","燃","狭","環","祝","管","肩","腕","腰","製","視","触","象","販","質","載","輸","述","違","量","額"],["与","候","効","含","居","属","巻","影","慣","抜","捕","捜","掛","景","替","構","模","況","渡","満","票","絞","肥","補","訟","訴","豊","輩","逮","限","隠","響","鮮"],["再","刺","創","励","占","印","往","従","復","徴","怪","我","振","授","接","故","汗","河","激","独","獣","突","筆","菓","討","豚","貯","較","造","郵","針","鉛","障"],["健","就","屈","康","怒","悩","惑","招","昇","暇","極","段","濃","症","痛","眠","睡","端","給","締","織","胃","腹","訪","誘","貸","迫","迷","退","途","郎","靴"],["並","修","傘","児","冷","凍","処","券","博","奇","妙","婦","巨","幼","庫","微","憲","撃","攻","浜","清","潔","益","移","程","稚","精","絶","綺","衆","逆","録","隊","麗"],["乾","促","催","僚","壊","娘","宗","宴","寄","怖","恐","杯","板","欧","江","添","烈","猛","略","監","督","積","索","緊","臣","航","街","診","詰","請","閣","雄","韓"],["乏","婚","延","快","懐","押","撮","旗","更","枕","浮","渇","漏","照","版","盗","符","系","翌","背","覧","貧","購","越","遊","適","預","飾","騒","魅"],["似","倉","偵","嘆","均","墓","孫","富","尋","巣","帯","幾","廊","径","徳","掃","探","救","散","既","普","棒","泥","粉","編","脈","菜","華","融","豪","貨","鑑","除","陸","離","驚"],["久","傷","党","卵","厳","密","序","志","恩","捨","採","暖","机","染","桜","欲","永","汚","液","眼","祖","秘","績","興","衛","複","訳","賛","込","迎","酸","銭","雑","飼"],["否","垂","宣","尊","忠","拡","操","敬","暮","漠","灰","熟","異","皇","盛","砂","窓","筋","簡","糖","納","肺","著","蒸","蔵","装","裏","誌","諸","賃","閉"],["丼","刻","勤","吐","奴","射","幕","承","拝","推","揮","損","枝","歓","沿","源","爪","磁","粋","紅","純","縦","縮","聖","腐","臓","芋","薦","誤","豆","貴","降","隷"],["亀","互","介","剣","厄","噌","寿","己","彫","彼","恥","払","杉","汁","油","測","湖","滞","炎","為","熊","獄","破","紹","舎","講","遅","酔","酢","醤","銅","鍋"],["伎","伸","依","債","及","奈","姓","将","幅","廃","換","摘","旧","核","沖","津","牙","献","甘","療","盟","継","維","縄","舞","般","諾","貿","超","踏","遺","頼","鹿"],["償","兆","刑","削","募","執","塁","契","崩","弾","恵","患","戻","抗","抱","抵","掲","旬","昭","湾","漁","爆","狙","聴","臨","葬","跡","跳","遣","闘","陣","香"],["伴","併","傾","刊","却","奏","奥","妊","娠","宜","慮","懸","房","扱","抑","択","描","盤","称","緒","緩","繰","致","託","賂","賄","贈","逃","避","還","需","齢"],["仙","充","免","勧","圏","埋","埼","壁","奪","岐","御","慎","拒","控","斐","枠","棋","渋","片","甲","祉","稲","群","謙","譲","躍","邦","鈴","銃","鋼","阜","隆","雇","項"],["俊","兼","剤","吹","唱","堀","孝","巡","戒","排","携","敏","敷","柱","殖","殿","犠","獲","繁","茂","薄","衝","褒","誉","透","鋭","隣","雅","頻","顧","駆","駐"],["仁","伺","侵","偽","儀","包","墟","徹","拠","拳","措","撤","棄","樹","潜","瀬","炭","畑","至","艦","虎","蛍","蜂","蜜","衣","誠","遜","郷","酎","鉱"],["克","到","双","哲","喪","堅","床","弧","括","挑","掘","揚","握","揺","斎","暫","析","枢","柄","泊","滑","潟","焦","範","糾","紛","綱","網","肝","芝","荒","袋","軸"],["刷","即","垣","威","封","岳","慰","懇","懲","摩","撲","擦","斉","旨","朗","柔","沈","沼","泰","滅","滋","潮","炉","牧","珍","琴","筒","籍","裂","襲","誰","貢","趣","距","露"],["丘","侍","俺","刃","匹","叫","叱","吉","塔","姫","娯","寸","嵐","忍","斗","朱","桃","梨","棚","涙","砲","竜","笠","粒","縁","缶","翼","芽","謎","辛","釣","雷","髪"],["也","井","凶","卓","呪","塊","塾","嫁","嬢","暦","曇","湿","溝","滝","澄","狂","狩","疲","眺","矛","硬","磨","稼","翔","肌","脚","舟","菌","裸","賭","鐘","陰","霊","頃","魂"],["俵","吾","墨","孔","寧","寮","帝","幽","庄","斬","架","棟","椅","歳","泡","涼","猿","癖","盆","瞬","瞳","碁","租","穂","穏","綿","菊","誇","鈍","錬","鍛","鍵","阻","零","魔","鳩","黙"],["伊","佐","哀","唇","塀","墜","如","婆","尺","崖","巾","帽","幣","恨","憎","憩","扇","扉","挿","掌","柳","欺","滴","炊","爽","畳","瞭","砕","箸","粘","粧","胴","芯","虹","詐","霧"],["咲","培","塗","尽","帳","彩","悔","憶","斜","殴","溶","灯","班","畜","盾","穫","耐","脅","脇","蓄","蚊","蛇","貼","賢","踊","輝","辱","迅","遂","鉢","闇","隙","霜","飢","餓","騎","麻"],["俗","刈","剛","劣","勘","唯","壇","奨","妃","尼","征","悟","抽","拓","拘","桑","概","浸","淡","潤","煮","珠","礎","紫","衰","覆","誓","謀","陛","陶","隔","駒","鶴"],["亭","仰","伯","偶","后","唐","堤","堰","墳","壮","奮","峰","巧","廷","彰","把","搬","晶","洞","涯","淀","漂","漫","疫","簿","翻","蟹","訂","諮","軌","邪","銘","駄","鬱","鰐"],["亮","偉","召","喚","塚","媛","慈","挟","枯","沸","浦","渦","濯","燥","玄","瓶","耕","聡","肪","肯","脂","膚","苗","蓮","襟","貞","軒","軟","邸","郊","郡","釈","隅","隻","頂"],["乃","倫","偏","呂","唆","噴","孤","怠","恒","惰","慢","擁","殊","没","牲","猟","祥","秩","糧","綾","膨","芳","茨","覇","貫","賠","輔","遇","遭","鎖","陥","陳","隼","須","颯"],["丹","准","剰","啓","壌","寛","帥","徐","惨","戴","披","据","搭","曙","浄","瓜","稿","緋","緯","繊","胞","胡","舗","艇","莉","葵","蒙","虐","諒","諭","錦","随","駿","騰","鯉"],["且","傲","冠","勲","卸","叙","呆","呈","哺","尚","庶","悠","愚","拐","杏","栞","栽","欄","疎","疾","痴","粛","紋","茎","茜","荘","謡","践","逸","酬","酷","鎌","阿","顕","鯨"],["之","伏","佳","傍","凝","奉","尿","弥","循","悼","惜","愉","憂","憾","抹","旦","昌","朴","栃","栓","瑛","癒","粗","累","脊","虜","該","賓","赴","遼","那","郭","鎮","髄","龍"],["凛","凡","匠","呉","嘉","宰","寂","尉","庸","弊","弦","恭","悦","拍","搾","摂","智","柴","洪","猶","碑","穀","窒","窮","紳","縛","縫","舶","蝶","轄","遥","錯","陵","靖","飽"],["乙","伐","俸","凸","凹","哉","喝","坪","堕","峡","弔","敢","旋","楓","槽","款","漬","烏","瑠","盲","紺","羅","胎","腸","膜","萌","蒼","衡","賊","遍","遮","酵","醸","閲","鼓"],["享","傑","凌","剖","嘱","奔","媒","帆","慨","憤","戯","扶","暁","朽","椎","殻","淑","漣","濁","瑞","璃","硫","窃","絹","肖","菅","藩","譜","赦","迭","酌","錠","陪","鶏"],["亜","侮","卑","叔","吟","堪","姻","屯","岬","峠","崇","忌","慶","憧","拙","擬","曹","梓","汰","沙","浪","漆","甚","睦","礁","禍","篤","紡","胆","蔑","詠","遷","酪","鋳","閑","雌"],["倹","劾","匿","升","唄","囚","坑","妄","婿","寡","廉","慕","拷","某","桟","殉","泌","渓","湧","漸","煩","狐","畔","痢","矯","罷","藍","藻","蛮","謹","逝","醜"],["蚕","壱","韻","畝","謁","艶","旺","翁","虞","箇","嚇","褐","棺","斤","薫","繭","侯","墾","采","肢","嗣","賜","爵","儒","愁","遵","抄","宵","硝","詔","薪","斥","繕"],["塑","但","逐","嫡","衷","勅","朕","逓","痘","謄","弐","頒","眉","附","賦","丙","倣","耗","冶","窯","濫","吏","厘","楼","弘","彦","李","浩","宏","旭","磯","萩","栗"],["辰","霞","淳","桂","晋","晃","桐","鷹","猪","紘","敦","祐","鵬","亘","笹","毅","稔","楊","椿","圭","伍","蘭","秦","茅","郁","楠","玲","肇","亨","嶺","喬","寅","洲"],["樺","槙","巌","峻","槻","琢","蕉","琉","朋","橘","漱","苑","巽","杜","欣","巴","禎","稜","倭","魁","鴻","於","赳","禄","孟","尭","巳","暢","芹","鳳","馨","慧","彬"],["匡","欽","嵯","綜","翠","鮎","榛","惣","蔦","渚","稀","芙","皐","雛","惟","佑","耀","黛","渥","惇","脩","甫","嬉","暉","只","檀","凱","彗","丑","叶","汐","絢","朔"],["伽","黎","冴","偲","允","蒔","舜","彪","卯","皓","洸","毬","鯛","怜","邑","碧","啄","穣","酉","悌","柚","亦","詢","紗","眸","玖","錘","諄","倖","笙","侃","裟","洵"],["爾","昴","銑","莞","伶","碩","宥","滉","晏","迪","綸","竣","晨","燦","麿","頌","琳","梧","澪","匁","晟","衿","凪","梢","茄","勺","恕","蕗","瑚","燎","柊","侑","嵩"],["捺","蓉","茉","袈","燿","誼","勁","菖","椋","叡","紬","胤","凜","亥","脹","麟","瑶","瑳","耶","椰","絃","丞","奎","昂","柾","熙","菫","鞠","崚","捷"]]
distribution = list(map(lambda x: len(x), wk))


def main():    
    start = time.time()

    #dictionary = getDictionary()
    deck = buildDeck(getDictionary())
    level = 1
    
    output = open(f"output/level_{level}.csv","w+",encoding="utf-8")
    for kanji in deck: 
        for word in kanji:
            # To output single file, comment out this condition
            if word[1] > level:
                output = open(f"output/level_{word[1]}.csv","w+",encoding="utf-8")
                level = word[1]
            line = "|".join(map(str, word))
            output.write(f"{line}")
    end = time.time()
    print(f"Done! Time elapsed: {end - start}s")

# Returns characters only found in the unicode block
def extract_unicode_block(unicode_block, string):
    return re.findall(unicode_block, string)

def buildDeck(dictionary):
    kanjistring = "".join(list(itertools.chain(*wk)))

    deck = [None] * len(kanjistring)

    for word in dictionary:
        uniq = word[0].split(";")[0]
        cleaned = extract_unicode_block(kanji, uniq)
        index = getHighestIndex(cleaned,kanjistring)
        if index != -1:
            highestKanji = kanjistring[index]
            level = getLevelFromKanji(index)
            entry = [highestKanji,level,word[0],word[1],word[2]]
            if deck[index] != None:
                deck[index].append(entry)
            else:
                deck[index] = [entry]
    return [i for i in deck if i] 

def getHighestIndex(word, lst):
    found = -1
    for char in word:
        index = lst.find(char)
        found = index if index != -1 else -1
        if found == -1: return -1
    return found

def getLevelFromKanji(i):
    total = 0
    for lvlnum, kanjicount in enumerate(distribution):
        if total <= i <= total + kanjicount:
            return lvlnum + 1
        total += kanjicount
    return 0

# Returns the dictionary as a list
def getDictionary():
    dictpath = "edict2"
    dictionary = []
    with open(dictpath,"r",encoding="utf-8") as fp:
        line = fp.readline()
        while line:
            word =  line.split('|')
            dictionary.append(word)
            line = fp.readline()
    return dictionary

if __name__ == "__main__":
    main()
